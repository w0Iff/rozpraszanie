FROM maven:3-eclipse-temurin-17-alpine AS mvn
WORKDIR /app
COPY pom.xml .
COPY src ./src

ARG PORT
ARG CASSANDRA_KEYSPACE_NAME
ARG CASSANDRA_USERNAME
ARG CASSANDRA_PASSWORD
ARG CASSANDRA_PORT
ARG CASSANDRA_CONTACT_POINT
ARG CASSANDRA_LOCAL_DATACENTER
ARG KAFKA_BOOTSTRAP_SERVERS
ARG KAFKA_TOPIC
ARG REDIRECT_SERVICE_HOST
ARG REDIRECT_SERVICE_PORT

ENV PORT=$PORT
ENV CASSANDRA_KEYSPACE_NAME=$CASSANDRA_KEYSPACE_NAME
ENV CASSANDRA_USERNAME=$CASSANDRA_USERNAME
ENV CASSANDRA_PASSWORD=$CASSANDRA_PASSWORD
ENV CASSANDRA_PORT=$CASSANDRA_PORT
ENV CASSANDRA_CONTACT_POINT=$CASSANDRA_CONTACT_POINT
ENV CASSANDRA_LOCAL_DATACENTER=$CASSANDRA_LOCAL_DATACENTER
ENV KAFKA_BOOTSTRAP_SERVERS=$KAFKA_BOOTSTRAP_SERVERS
ENV KAFKA_TOPIC=$KAFKA_TOPIC
ENV REDIRECT_SERVICE_HOST=$REDIRECT_SERVICE_HOST
ENV REDIRECT_SERVICE_PORT=$REDIRECT_SERVICE_PORT

RUN mvn -e -B package -P prod -DskipTests

FROM eclipse-temurin:17-alpine
WORKDIR /app

COPY src/main/resources /app/resources

COPY --from=mvn /app/target/shorted_microservice-0.0.1-SNAPSHOT.jar .
EXPOSE $PORT
CMD ["java", "-jar", "shorted_microservice-0.0.1-SNAPSHOT.jar"]